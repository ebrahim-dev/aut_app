<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Public Key Generator</title>
  </head>
  <body>
    <h1>Public Key Generator</h1>

    <h2>Generate Public Key</h2>
    <input id="email" type="text" placeholder="E-mail" /><br />
    <input id="privateKey" type="text" placeholder="Private Key" /><br />
    <button onclick="generate()">Generate Public Key</button>
    <p id="generatedPublicKey"></p>

    <h2>Retrieve Details from Challenge</h2>
    <input id="publicKey" type="text" placeholder="Ondertekening" /><br />
    <button onclick="retrieve()">Retrieve Details</button>
    <p id="retrievedDetails"></p>
    <p id="regeneratedPublicKey"></p>

    <h2>Generate from Details</h2>
    <p id="generatedFromDetails"></p>

    <h2>Show Details from challenge</h2>
    <button onclick="showDetailsFromGenerated()">
      Show Details from challenge
    </button>
    <button onclick="clering()">Clearing data</button>
    <p id="processedResult"></p>
    <p id="newGeneratedDetails"></p>
    <h1>Registratieformulier</h1>
    <form id="registrationForm">
      <label for="getEmail">E-mail:</label>
      <input type="email" id="getEmail" name="getEmail" required /><br /><br />
      <label for="newerPublicKey">New Public Key:</label>
      <input type="text" id="newerPublicKey" name="newerPublicKey" required />
      <br /><br />
      <label for="onderTekening">Ondertekening:</label>
      <input type="text" id="onderTekening" name="onderTekening" required />
      <br /><br />
      <label for="sign1">Sign1:</label>
      <input type="text" id="sign1" name="sign1" required />
      <br /><br />
      <label for="sign2">Sign2:</label>
      <input type="text" id="sign2" name="sign2" required />
      <br /><br />
      <input type="submit" value="Registreren" />
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const rawId = urlParams.get("rawId");
        const gotEmail = urlParams.get("username");
        const privateKeyElement = document.getElementById("privateKey");
        const emailElement = document.getElementById("email");
        if (rawId && privateKeyElement) {
          privateKeyElement.value = rawId;
        }
        if (gotEmail && emailElement) {
          emailElement.value = gotEmail;
        }
      });

      function clering() {
        localStorage.clear();
      }

      async function generate() {
        const email = document.getElementById("email").value;
        const privateKey = document.getElementById("privateKey").value;
        const publicKey = await generatePublicKey(email, privateKey);
        document.getElementById(
          "generatedPublicKey"
        ).innerText = `Ondertekening: ${publicKey}`;
        document.getElementById("getEmail").value = email;
        document.getElementById("onderTekening").value = publicKey;

        // Automatically fill the Retrieve Details from Public Key field
        document.getElementById("publicKey").value = publicKey;

        // Automatically trigger the retrieve function
        retrieve();
      }
      async function generatePublicKey(email, privateKey) {
        const encoder = new TextEncoder();
        const data = encoder.encode(`${email}-${privateKey}`);
        const buffer = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(buffer))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      async function retrieve() {
        const publicKey = document.getElementById("publicKey").value;

        if (publicKey) {
          const details = await retrieveDetailsFromPublicKey(publicKey);

          if (details) {
            const [signal1, signal2] = details;
            const resultText = `Signal1: ${signal1}\nSignal2: ${signal2}`;
            document.getElementById("sign1").value = signal1;
            document.getElementById("sign2").value = signal2;

            document.getElementById("retrievedDetails").innerText = resultText;
            generateFromDetails(signal1, signal2);
          } else {
            document.getElementById("retrievedDetails").innerText =
              "Geen details gevonden voor deze Public Key";
          }
        } else {
          document.getElementById("retrievedDetails").innerText =
            "Vul een Public Key in om details op te halen.";
        }
      }

      async function retrieveDetailsFromPublicKey(publicKey) {
        const signal1 = hexToString(publicKey.slice(0, 10));
        const signal2 = hexToString(publicKey.slice(10));
        return [signal1, signal2];
      }

      function hexToString(hex) {
        let str = "";
        for (let i = 0; i < hex.length; i += 2) {
          const charCode = parseInt(hex.substr(i, 2), 16);
          str += String.fromCharCode(charCode);
        }
        return str;
      }

      async function generateFromDetails(key1, key2) {
        // const retrievedDetails =
        //   document.getElementById("retrievedDetails").innerText;
        // const [signal1, signal2] = parseDetails(retrievedDetails);

        if (key1 && key2) {
          const newPublicKey = await generatePublicKey(key1, key2);
          document.getElementById("newerPublicKey").value = newPublicKey;
          document.getElementById(
            "generatedFromDetails"
          ).innerText = `Generated Public Key from Details: ${newPublicKey}`;
          const sign1 = key1;
          const sign2 = key2;
          const email = document.getElementById("email").value;
          const privateKey = document.getElementById("privateKey").value;
          return { email, privateKey, newPublicKey, sign1, sign2 };
        } else {
          document.getElementById("generatedFromDetails").innerText =
            "Kan geen nieuwe publicKey genereren zonder geldige gegevens.";
          return null;
        }
      }

      async function showDetailsFromGenerated() {
        const retrievedDetails =
          document.getElementById("retrievedDetails").innerText;
        const [signal1, signal2] = parseDetails(retrievedDetails);
        key1 = signal1;
        key2 = signal2;
        const processedResult = await generateFromDetails(key1, key2);

        if (processedResult) {
          const { email, privateKey, newPublicKey, sign1, sign2 } =
            processedResult;
          const userDetails = {
            email,
            privateKey,
            sign1,
            sign2,
          };
          // Haal bestaande gegevens op (als die er zijn)
          let existingDetails =
            JSON.parse(localStorage.getItem("userDetails")) || [];

          // Controleer of existingDetails een array is
          if (!Array.isArray(existingDetails)) {
            existingDetails = [];
          }

          // Voeg nieuwe gegevens toe aan de bestaande gegevens
          existingDetails.push(userDetails);
          // Converteer naar JSON-string en sla op in localStorage
          localStorage.setItem("userDetails", JSON.stringify(existingDetails));

          console.log(existingDetails);
          document.getElementById(
            "newGeneratedDetails"
          ).innerText = `Email: ${email}\nPrivate Sleutel: ${privateKey}\nNew Public Key: ${newPublicKey}\nSign1: ${sign1}\nSign2: ${sign2}`;
        } else {
          document.getElementById("processedResult").innerText =
            "Kan geen details verwerken zonder geldige gegevens.";
          document.getElementById("newGeneratedDetails").innerText = "";
        }
      }
      async function showingDetailsFromGenerated() {
        const retrievedDetails =
          document.getElementById("retrievedDetails").innerText;
        const [signal1, signal2] = parseDetails(retrievedDetails);
        key1 = signal1;
        key2 = signal2;
        const processedResult = await generateFromDetails(key1, key2);

        if (processedResult) {
          const { email, privateKey, newPublicKey, sign1, sign2 } =
            processedResult;
          const userDetails = {
            email,
            privateKey,
            sign1,
            sign2,
          };

          // Stuur de gegevens naar de server
          const response = await fetch("http://localhost:4000/savedData", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userDetails),
          });

          if (response.ok) {
            console.log("Gegevens succesvol naar de server gestuurd.");
          } else {
            console.error(
              "Fout bij het verzenden van gegevens naar de server."
            );
          }

          console.log(
            `Email: ${email}\nPrivate Sleutel: ${privateKey}\nNew Public Key: ${newPublicKey}\nSign1: ${sign1}\nSign2:${sign2}`
          );
        } else {
          document.getElementById("processedResult").innerText =
            "Kan geen details verwerken zonder geldige gegevens.";
          document.getElementById("newGeneratedDetails").innerText = "";
        }
      }

      function parseDetails(details) {
        const matches = details.match(/Signal1: (.+)\nSignal2: (.+)/);
        if (matches && matches.length === 3) {
          return [matches[1], matches[2]];
        } else {
          return [null, null];
        }
      }

      document
        .getElementById("registrationForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          var gettingEmail = document.getElementById("getEmail").value;
          var newerPublicKey = document.getElementById("newerPublicKey").value;
          var ondertekening = document.getElementById("onderTekening").value;
          var sign1 = document.getElementById("sign1").value;
          var sign2 = document.getElementById("sign2").value;

          // Stuur de gegevens naar de server
          fetch("http://localhost:4000/registerUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              gettingEmail,
              newerPublicKey,
              ondertekening,
              sign1,
              sign2,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showingDetailsFromGenerated();
                showDetailsFromGenerated();
                alert("Registratie succesvol!");
              } else {
                alert("Registratie mislukt: " + data.message);
              }
            })
            .catch((error) => console.error("Fout bij registratie:", error));
        });
    </script>
  </body>
</html>
