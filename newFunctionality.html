<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Public Key Generator</title>
  </head>
  <body>
    <h1>Public Key Generator</h1>

    <h2>Generate Public Key</h2>
    <input id="email" type="text" placeholder="E-mail" /><br />
    <input id="privateKey" type="text" placeholder="Private Key" /><br />
    <button onclick="generate()">Generate Public Key</button>
    <p id="generatedPublicKey"></p>

    <h2>Retrieve Details from Public Key</h2>
    <input id="publicKey" type="text" placeholder="Ondertekening" /><br />
    <button onclick="retrieve()">Retrieve Details</button>
    <p id="retrievedDetails"></p>
    <p id="regeneratedPublicKey"></p>

    <h2>Generate from Details</h2>
    <button onclick="generateFromDetails()">Generate from Details</button>
    <p id="generatedFromDetails"></p>

    <h2>Show Details from Generated Public Key</h2>
    <button onclick="showDetailsFromGenerated()">
      Show Details from Generated Public Key
    </button>
    <button onclick="clering()">Clearing data</button>
    <p id="processedResult"></p>
    <p id="newGeneratedDetails"></p>
    <h1>Registratieformulier</h1>
    <form id="registrationForm">
      <label for="getEmail">E-mail:</label>
      <input type="email" id="getEmail" name="getEmail" required /><br /><br />
      <label for="newerPublicKey">New Public Key:</label>
      <input type="text" id="newerPublicKey" name="newerPublicKey" required />
      <br /><br />
      <label for="onderTekening">Ondertekening:</label>
      <input type="text" id="onderTekening" name="onderTekening" required />
      <br /><br />
      <label for="sign1">Ondertekening:</label>
      <input type="text" id="sign1" name="sign1" required />
      <br /><br />
      <label for="sign2">Ondertekening:</label>
      <input type="text" id="sign2" name="sign2" required />
      <br /><br />
      <input type="submit" value="Registreren" />
    </form>

    <script>
      function clering() {
        localStorage.clear();
      }
      async function generatePublicKey(email, privateKey) {
        const encoder = new TextEncoder();
        const data = encoder.encode(`${email}-${privateKey}`);
        const buffer = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(buffer))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      async function retrieveDetailsFromPublicKey(publicKey) {
        const email = hexToString(publicKey.slice(0, 10));
        const privateKey = hexToString(publicKey.slice(10));
        return [email, privateKey];
      }

      function hexToString(hex) {
        let str = "";
        for (let i = 0; i < hex.length; i += 2) {
          const charCode = parseInt(hex.substr(i, 2), 16);
          str += String.fromCharCode(charCode);
        }
        return str;
      }

      async function generate() {
        const email = document.getElementById("email").value;
        const privateKey = document.getElementById("privateKey").value;
        const publicKey = await generatePublicKey(email, privateKey);
        document.getElementById(
          "generatedPublicKey"
        ).innerText = `Ondertekening: ${publicKey}`;
        document.getElementById("getEmail").value = email;
        document.getElementById("onderTekening").value = publicKey;

        // Automatically fill the Retrieve Details from Public Key field
        document.getElementById("publicKey").value = publicKey;

        // Automatically trigger the retrieve function
        retrieve();
      }

      async function retrieve() {
        const publicKey = document.getElementById("publicKey").value;

        if (publicKey) {
          const details = await retrieveDetailsFromPublicKey(publicKey);

          if (details) {
            const [email, privateKey] = details;
            const resultText = `Email: ${email}\nPrivate Sleutel: ${privateKey}`;
            document.getElementById("sign1").value = email;
            document.getElementById("sign2").value = privateKey;

            document.getElementById("retrievedDetails").innerText = resultText;

            // Regenerate the public key and display it
            // const regeneratedPublicKey = await generatePublicKey(
            //   email + privateKey
            // );
            // document.getElementById(
            //   "regeneratedPublicKey"
            // ).innerText = `Regenerated Public Key: ${regeneratedPublicKey}`;

            // Automatically fill the Generated from Details field
            // document.getElementById(
            //   "generatedFromDetails"
            // ).innerText = `Generated Public Key from Details: ${publicKey}`;

            // Automatically trigger the Show Details from Generated Public Key function
            //
            generateFromDetails();
          } else {
            document.getElementById("retrievedDetails").innerText =
              "Geen details gevonden voor deze Public Key";
          }
        } else {
          document.getElementById("retrievedDetails").innerText =
            "Vul een Public Key in om details op te halen.";
        }
      }

      async function generateFromDetails() {
        const retrievedDetails =
          document.getElementById("retrievedDetails").innerText;
        const [email, privateKey] = parseDetails(retrievedDetails);

        if (email && privateKey) {
          const newPublicKey = await generatePublicKey(email, privateKey);
          document.getElementById("newerPublicKey").value = newPublicKey;
          document.getElementById(
            "generatedFromDetails"
          ).innerText = `Generated Public Key from Details: ${newPublicKey}`;
          const sign1 = email;
          const sign2 = privateKey;

          return { email, privateKey, newPublicKey, sign1, sign2 };
        } else {
          document.getElementById("generatedFromDetails").innerText =
            "Kan geen nieuwe openbare sleutel genereren zonder geldige gegevens.";
          return null;
        }
      }

      async function showDetailsFromGenerated() {
        const processedResult = await generateFromDetails();

        if (processedResult) {
          const { email, privateKey, newPublicKey } = processedResult;
          const userDetails = {
            email,
            privateKey,
          };
          // Haal bestaande gegevens op (als die er zijn)
          let existingDetails =
            JSON.parse(localStorage.getItem("userDetails")) || [];

          // Controleer of existingDetails een array is
          if (!Array.isArray(existingDetails)) {
            existingDetails = [];
          }

          // Voeg nieuwe gegevens toe aan de bestaande gegevens
          existingDetails.push(userDetails);
          // Converteer naar JSON-string en sla op in localStorage
          localStorage.setItem("userDetails", JSON.stringify(existingDetails));
          // existingDetails = [];
          // localStorage.clear();

          console.log(existingDetails);
          document.getElementById(
            "newGeneratedDetails"
          ).innerText = `Email: ${email}\nPrivate Sleutel: ${privateKey}\nNew Public Key: ${newPublicKey}`;
        } else {
          document.getElementById("processedResult").innerText =
            "Kan geen details verwerken zonder geldige gegevens.";
          document.getElementById("newGeneratedDetails").innerText = "";
        }
      }
      async function showingDetailsFromGenerated() {
        const processedResult = await generateFromDetails();

        if (processedResult) {
          const { email, privateKey, newPublicKey } = processedResult;
          const userDetails = {
            email,
            privateKey,
          };

          // Stuur de gegevens naar de server
          const response = await fetch("http://localhost:4000/savedData", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userDetails),
          });

          if (response.ok) {
            console.log("Gegevens succesvol naar de server gestuurd.");
          } else {
            console.error(
              "Fout bij het verzenden van gegevens naar de server."
            );
          }

          console.log(
            `Email: ${email}\nPrivate Sleutel: ${privateKey}\nNew Public Key: ${newPublicKey}`
          );
        } else {
          document.getElementById("processedResult").innerText =
            "Kan geen details verwerken zonder geldige gegevens.";
          document.getElementById("newGeneratedDetails").innerText = "";
        }
      }

      function parseDetails(details) {
        const matches = details.match(/Email: (.+)\nPrivate Sleutel: (.+)/);
        if (matches && matches.length === 3) {
          return [matches[1], matches[2]];
        } else {
          return [null, null];
        }
      }

      document
        .getElementById("registrationForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          var getEmail = document.getElementById("getEmail").value;
          var newerPublicKey = document.getElementById("newerPublicKey").value;
          var ondertekening = document.getElementById("onderTekening").value;
          var sign1 = document.getElementById("sign1").value;
          var sign2 = document.getElementById("sign2").value;

          // Stuur de gegevens naar de server
          fetch("http://localhost:4000/registerUser", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              getEmail,
              newerPublicKey,
              ondertekening,
              sign1,
              sign2,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showingDetailsFromGenerated();
                showDetailsFromGenerated();
                alert("Registratie succesvol!");
              } else {
                alert("Registratie mislukt: " + data.message);
              }
            })
            .catch((error) => console.error("Fout bij registratie:", error));
        });
    </script>
  </body>
</html>
